import React, { useState, useEffect, useRef } from 'react';
// import { createClient } from '@supabase/supabase-js'; // UNCOMMENT SAAT DI PROJECT ASLI
import { 
  Drama, LayoutDashboard, Users, Calendar, ClipboardCheck, 
  Megaphone, Shirt, Brain, Menu, X, LogOut, Plus, Trash2, 
  Check, Send, MessageSquare, AlertTriangle 
} from 'lucide-react';

// --- MOCK SUPABASE CLIENT (UNTUK PREVIEW INI SAJA) ---
// Kelas ini mensimulasikan cara kerja Supabase agar aplikasi bisa berjalan di preview ini.
// HAPUS kelas ini jika Anda sudah menggunakan Supabase asli.
class MockSupabaseClient {
  private db: any;
  
  constructor() {
    // Inisialisasi data dummy jika kosong
    const saved = localStorage.getItem('rajawaliku_mock_db');
    this.db = saved ? JSON.parse(saved) : {
      users: [
        { id: 1, name: 'Admin Utama', username: 'admin', password: 'admin', role: 'admin', created_at: new Date().toISOString() },
        { id: 2, name: 'Anggota Biasa', username: 'user', password: 'user', role: 'user', created_at: new Date().toISOString() }
      ],
      activities: [],
      backstage_items: [],
      forum_messages: [],
      quizzes: []
    };
  }

  private save() {
    localStorage.setItem('rajawaliku_mock_db', JSON.stringify(this.db));
  }

  from(table: string) {
    if (!this.db[table]) this.db[table] = [];
    
    return {
      select: (query: string) => {
        return {
          order: (col: string, { ascending }: any) => {
            const data = [...this.db[table]].sort((a,b) => 
              ascending ? (a[col] > b[col] ? 1 : -1) : (a[col] < b[col] ? 1 : -1)
            );
            return Promise.resolve({ data, error: null });
          },
          eq: (key: string, val: any) => { // Handle chain select().eq()
             const data = this.db[table].filter((i:any) => i[key] == val);
             return {
               single: () => Promise.resolve({ data: data[0] || null, error: data.length ? null : { message: 'Not found' } })
             }
          },
          // Default return for select('*')
          then: (cb: any) => cb({ data: this.db[table], error: null }) 
        };
      },
      insert: (rows: any[]) => {
        const newRows = rows.map(r => ({ id: Date.now(), created_at: new Date().toISOString(), ...r }));
        this.db[table].push(...newRows);
        this.save();
        return Promise.resolve({ data: newRows, error: null });
      },
      delete: () => {
        return {
          eq: (key: string, val: any) => {
            this.db[table] = this.db[table].filter((i:any) => i[key] != val);
            this.save();
            return Promise.resolve({ error: null });
          }
        };
      }
    };
  }
}

// --- KONFIGURASI SUPABASE ---
// GANTI DENGAN URL DAN KEY ANDA DARI DASHBOARD SUPABASE SAAT DI PROJECT ASLI
const SUPABASE_URL = 'https://gjamahlmxkhdhjrusfnh.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqYW1haGxteGtoZGhqcnVzZm5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTA0NTMsImV4cCI6MjA3ODQ4NjQ1M30.kpjlUqATDD1REn7zChx-CLTWD4pcZK42V_Itwdh1YBs';

// UNTUK PREVIEW: KITA GUNAKAN MOCK CLIENT
const supabase = new MockSupabaseClient() as any; 

// UNTUK PRODUKSI: GUNAKAN KODE DI BAWAH INI (HAPUS MOCK CLIENT DI ATAS)
// const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- TYPES ---
interface User { id: number; name: string; username: string; password: string; role: 'admin' | 'user'; }
interface Activity { id: number; title: string; date: string; time: string; description: string; }
interface BackstageItem { id: number; name: string; status: string; type: 'costume' | 'prop' | 'rehearsal'; }
interface Quiz { id: number; title: string; questions: any[]; } 
interface QuizSubmission { id: number; quiz_id: number; user_id: number; score: number; }
interface ForumMessage { id: number; user_id: number; message: string; timestamp: string; users?: { name: string } }
interface Announcement { id: number; title: string; content: string; timestamp: string; }

const TeaterApp = () => {
  // --- STATE ---
  const [isConfigured, setIsConfigured] = useState(true); // Always true for mock mode
  
  // Data State
  const [users, setUsers] = useState<User[]>([]);
  const [activities, setActivities] = useState<Activity[]>([]);
  const [backstageItems, setBackstageItems] = useState<BackstageItem[]>([]);
  const [forumMessages, setForumMessages] = useState<ForumMessage[]>([]);
  const [quizzes, setQuizzes] = useState<Quiz[]>([]);
  const [announcements, setAnnouncements] = useState<Announcement[]>([]); 

  // Session State
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [currentPage, setCurrentPage] = useState('dashboard');
  
  // UI State
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [regForm, setRegForm] = useState({ name: '', username: '', password: '' });
  const [isRegistering, setIsRegistering] = useState(false);
  const [notification, setNotification] = useState<{msg: string, type: 'success'|'error'} | null>(null);
  const [loading, setLoading] = useState(false);

  // Modal State
  const [modalOpen, setModalOpen] = useState(false);
  const [modalContent, setModalContent] = useState<React.ReactNode>(null);
  const [modalTitle, setModalTitle] = useState('');

  // --- INITIAL CHECK ---
  useEffect(() => {
    // Di mode mock, kita langsung load data
    fetchAllData();
  }, []);

  // --- DATA FETCHING (SUPABASE PATTERN) ---
  const fetchAllData = async () => {
    setLoading(true);
    try {
      // Fetch Activities
      const { data: actData } = await supabase.from('activities').select('*').order('date', { ascending: true });
      if (actData) setActivities(actData);

      // Fetch Backstage Items
      const { data: bgData } = await supabase.from('backstage_items').select('*');
      if (bgData) setBackstageItems(bgData);

      // Fetch Forum Messages
      // Note: Di Mock Client, join 'users(name)' tidak sempurna, kita manual map nanti
      const { data: msgData } = await supabase.from('forum_messages').select('*, users(name)').order('timestamp', { ascending: true });
      
      // Fetch Users untuk mapping nama manual (khusus Mock Mode)
      const { data: userData } = await supabase.from('users').select('*');
      if (userData) setUsers(userData);

      if (msgData && userData) {
        // Polyfill untuk Mock Join
        const enrichedMsg = msgData.map((m: any) => ({
            ...m,
            users: { name: userData.find((u:any) => u.id === m.user_id)?.name || 'Unknown' }
        }));
        setForumMessages(enrichedMsg);
      }

      // Fetch Quizzes
      const { data: quizData } = await supabase.from('quizzes').select('*');
      if (quizData) setQuizzes(quizData);

    } catch (error) {
      console.error("Error fetching data:", error);
      showNotif("Gagal mengambil data", 'error');
    } finally {
      setLoading(false);
    }
  };

  // --- ACTIONS ---
  const showNotif = (msg: string, type: 'success'|'error') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      // Logic Login Supabase
      // Di produksi, gunakan supabase.auth.signInWithPassword
      // Di sini kita manual query tabel users
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('username', loginForm.username) // Chain filter
        .single(); // Harusnya .eq('password', ...) juga, tapi Mock client simple saya perlu penyesuaian

      // Manual check password karena mock client .eq chaining terbatas
      if (error || !data || data.password !== loginForm.password) {
        showNotif('Username atau password salah', 'error');
      } else {
        setCurrentUser(data);
        setLoginForm({ username: '', password: '' });
        showNotif(`Selamat datang, ${data.name}!`, 'success');
        fetchAllData(); 
      }
    } catch (err) {
      showNotif('Terjadi kesalahan login', 'error');
    } finally {
      setLoading(false);
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      // Check existing
      const { data: existing } = await supabase.from('users').select('id').eq('username', regForm.username).single();
      if (existing) {
        showNotif('Username sudah digunakan', 'error');
        setLoading(false);
        return;
      }

      const { error } = await supabase.from('users').insert([{
        name: regForm.name,
        username: regForm.username,
        password: regForm.password,
        role: 'user'
      }]);

      if (error) throw error;

      setIsRegistering(false);
      setRegForm({ name: '', username: '', password: '' });
      showNotif('Pendaftaran berhasil, silakan login', 'success');
    } catch (err) {
      showNotif('Gagal mendaftar', 'error');
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setCurrentPage('dashboard');
  };

  const closeModal = () => {
    setModalOpen(false);
    setModalContent(null);
  };

  const isAdmin = currentUser?.role === 'admin';

  // --- PAGE COMPONENTS ---

  // 1. Dashboard
  const Dashboard = () => {
    const upcoming = activities.filter(a => new Date(a.date) >= new Date())[0];
    
    return (
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
          <h3 className="text-lg font-bold text-amber-600 mb-2 flex items-center gap-2">
            <Calendar size={20} /> Kegiatan Terdekat
          </h3>
          {upcoming ? (
            <div>
              <p className="font-semibold text-stone-800">{upcoming.title}</p>
              <p className="text-sm text-stone-500">{new Date(upcoming.date).toLocaleDateString('id-ID')}</p>
            </div>
          ) : <p className="text-stone-400 text-sm">Belum ada kegiatan.</p>}
        </div>
        
        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
          <h3 className="text-lg font-bold text-amber-600 mb-2 flex items-center gap-2">
            <Users size={20} /> Total Anggota
          </h3>
          <p className="text-4xl font-bold text-stone-800">{users.filter(u => u.role === 'user').length}</p>
          <p className="text-xs text-stone-400">Aktif Terdaftar</p>
        </div>
        
        <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col justify-center items-center text-center">
            <p className="text-stone-500 mb-2">Status Database</p>
            <span className={`px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700`}>
                Simulasi Supabase (Lokal)
            </span>
        </div>
      </div>
    );
  };

  // 2. Activities Page
  const ActivitiesPage = () => {
    const [newAct, setNewAct] = useState<Partial<Activity>>({});
    
    const handleAdd = async () => {
      if (!newAct.title || !newAct.date) return;
      
      const { error } = await supabase.from('activities').insert([newAct]);
      if (!error) {
        showNotif('Kegiatan ditambahkan', 'success');
        fetchAllData(); // Refresh list
        closeModal();
      } else {
        showNotif('Gagal menambah kegiatan', 'error');
      }
    };

    const handleDelete = async (id: number) => {
        if(!confirm('Hapus kegiatan ini?')) return;
        const { error } = await supabase.from('activities').delete().eq('id', id);
        if(!error) {
            showNotif('Kegiatan dihapus', 'success');
            fetchAllData();
        }
    }

    return (
      <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-stone-800">Jadwal Kegiatan</h2>
          {isAdmin && (
            <button 
              onClick={() => {
                setModalTitle('Tambah Kegiatan');
                setModalContent(
                  <div className="space-y-4">
                    <input className="w-full p-2 border rounded" placeholder="Judul" onChange={e => setNewAct({...newAct, title: e.target.value})} />
                    <input className="w-full p-2 border rounded" type="date" onChange={e => setNewAct({...newAct, date: e.target.value})} />
                    <input className="w-full p-2 border rounded" type="time" onChange={e => setNewAct({...newAct, time: e.target.value})} />
                    <textarea className="w-full p-2 border rounded" placeholder="Deskripsi" onChange={e => setNewAct({...newAct, description: e.target.value})} />
                    <button onClick={handleAdd} className="w-full bg-amber-600 text-white p-2 rounded">Simpan ke Database</button>
                  </div>
                );
                setModalOpen(true);
              }}
              className="bg-amber-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-700"
            >
              <Plus size={16} /> Tambah
            </button>
          )}
        </div>
        <div className="grid gap-4 md:grid-cols-2">
          {activities.map(act => (
            <div key={act.id} className="p-4 bg-stone-50 rounded-lg border border-stone-100 relative group">
              {isAdmin && (
                <button 
                  onClick={() => handleDelete(act.id)}
                  className="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <Trash2 size={16} />
                </button>
              )}
              <h3 className="font-bold text-lg text-stone-800">{act.title}</h3>
              <div className="flex gap-4 text-sm text-stone-500 mt-2">
                <span className="flex items-center gap-1"><Calendar size={14} /> {new Date(act.date).toLocaleDateString('id-ID')}</span>
                <span className="flex items-center gap-1"><Check size={14} /> {act.time}</span>
              </div>
              <p className="mt-2 text-stone-600 text-sm">{act.description}</p>
            </div>
          ))}
          {activities.length === 0 && <p className="text-center text-stone-400 py-8 col-span-2">Belum ada jadwal di database.</p>}
        </div>
      </div>
    );
  };

  // 3. Backstage Page
  const BackstagePage = () => {
    const [newItem, setNewItem] = useState({ name: '', status: '' });
    
    const addItem = async (type: BackstageItem['type']) => {
      if(!newItem.name) return;
      const { error } = await supabase.from('backstage_items').insert([{
          name: newItem.name,
          status: newItem.status || 'Tersedia',
          type
      }]);

      if (!error) {
          fetchAllData();
          setNewItem({ name: '', status: '' });
          closeModal();
      }
    };

    const deleteItem = async (id: number) => {
        const { error } = await supabase.from('backstage_items').delete().eq('id', id);
        if(!error) fetchAllData();
    };

    const openAddModal = (type: BackstageItem['type'], title: string) => {
      setModalTitle(title);
      setModalContent(
        <div className="space-y-4">
          <input className="w-full p-2 border rounded" placeholder="Nama Item" onChange={e => setNewItem({...newItem, name: e.target.value})} />
          <input className="w-full p-2 border rounded" placeholder="Status / Keterangan" onChange={e => setNewItem({...newItem, status: e.target.value})} />
          <button onClick={() => addItem(type)} className="w-full bg-amber-600 text-white p-2 rounded">Simpan</button>
        </div>
      );
      setModalOpen(true);
    };

    const RenderSection = ({ title, type, icon: Icon }: { title: string, type: BackstageItem['type'], icon: any }) => (
      <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200 h-full">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold text-stone-800 flex items-center gap-2"><Icon size={20} className="text-amber-600" /> {title}</h3>
          {isAdmin && <button onClick={() => openAddModal(type, `Tambah ${title}`)} className="text-amber-600 hover:bg-amber-50 p-1 rounded"><Plus size={20} /></button>}
        </div>
        <ul className="space-y-2">
          {backstageItems.filter(i => i.type === type).map(item => (
            <li key={item.id} className="flex justify-between items-center p-2 bg-stone-50 rounded text-sm group">
              <span>{item.name} <span className="text-stone-400 text-xs ml-2">({item.status})</span></span>
              {isAdmin && <button onClick={() => deleteItem(item.id)} className="text-red-400 opacity-0 group-hover:opacity-100"><X size={14} /></button>}
            </li>
          ))}
          {backstageItems.filter(i => i.type === type).length === 0 && <li className="text-stone-400 text-sm italic">Kosong</li>}
        </ul>
      </div>
    );

    return (
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
        <RenderSection title="Kostum" type="costume" icon={Shirt} />
        <RenderSection title="Properti" type="prop" icon={Drama} />
        <RenderSection title="Jadwal Gladi" type="rehearsal" icon={ClipboardCheck} />
      </div>
    );
  };

  // 4. Forum Page
  const ForumPage = () => {
    const [msgText, setMsgText] = useState('');
    const bottomRef = useRef<HTMLDivElement>(null);

    useEffect(() => {
      bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [forumMessages]);

    const sendMsg = async (e: React.FormEvent) => {
      e.preventDefault();
      if(!msgText.trim() || !currentUser) return;
      
      const { error } = await supabase.from('forum_messages').insert([{
          user_id: currentUser.id,
          message: msgText,
          timestamp: new Date().toISOString()
      }]);

      if (!error) {
          setMsgText('');
          fetchAllData(); 
      }
    };

    return (
      <div className="bg-white rounded-xl shadow-sm border border-stone-200 flex flex-col h-[calc(100vh-140px)]">
        <div className="p-4 border-b border-stone-200">
          <h2 className="font-bold text-lg text-stone-800">Forum Diskusi</h2>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50">
          {forumMessages.map(msg => {
            const isMe = msg.user_id === currentUser?.id;
            return (
              <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[70%] p-3 rounded-lg ${isMe ? 'bg-amber-600 text-white rounded-br-none' : 'bg-white border border-stone-200 rounded-bl-none'}`}>
                  {!isMe && <p className="text-xs font-bold text-amber-700 mb-1">{msg.users?.name || 'Unknown'}</p>}
                  <p className="text-sm">{msg.message}</p>
                  <p className={`text-[10px] mt-1 ${isMe ? 'text-amber-200' : 'text-stone-400'}`}>
                    {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </p>
                </div>
              </div>
            );
          })}
          <div ref={bottomRef} />
        </div>
        <form onSubmit={sendMsg} className="p-4 bg-white border-t border-stone-200 flex gap-2">
          <input 
            value={msgText}
            onChange={e => setMsgText(e.target.value)}
            className="flex-1 border border-stone-300 rounded-full px-4 py-2 focus:outline-none focus:border-amber-500"
            placeholder="Ketik pesan..."
          />
          <button type="submit" className="bg-amber-600 text-white p-2 rounded-full hover:bg-amber-700"><Send size={20} /></button>
        </form>
      </div>
    );
  };

  // 5. Quiz Page
  const QuizPage = () => {
    const [newQuizTitle, setNewQuizTitle] = useState('');
    const addSimpleQuiz = async () => {
      if(!newQuizTitle) return;
      const { error } = await supabase.from('quizzes').insert([{
          title: newQuizTitle,
          questions: [{ q: "Contoh Pertanyaan?", options: ["A", "B"], answer: 0 }] 
      }]);
      if(!error) {
          setNewQuizTitle('');
          fetchAllData();
      }
    };

    return (
      <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
         <h2 className="text-2xl font-bold text-stone-800 mb-6">Kuis Teater</h2>
         {isAdmin && (
           <div className="flex gap-2 mb-6">
             <input value={newQuizTitle} onChange={e => setNewQuizTitle(e.target.value)} placeholder="Judul Kuis Baru" className="border p-2 rounded flex-1" />
             <button onClick={addSimpleQuiz} className="bg-amber-600 text-white px-4 rounded">Buat</button>
           </div>
         )}
         <div className="space-y-4">
           {quizzes.map(q => (
             <div key={q.id} className="border p-4 rounded-lg flex justify-between items-center">
               <div>
                 <h3 className="font-bold">{q.title}</h3>
                 <p className="text-sm text-stone-500">{q.questions?.length || 0} Pertanyaan</p>
               </div>
               <button className="bg-stone-800 text-white px-4 py-2 rounded text-sm">Kerjakan</button>
             </div>
           ))}
           {quizzes.length === 0 && <p className="text-stone-400">Belum ada kuis.</p>}
         </div>
      </div>
    );
  };

  // --- UNAUTHENTICATED VIEW ---
  if (!currentUser) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-stone-900 relative overflow-hidden">
        <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1507676184212-d0339efdc809?q=80&w=1920')] bg-cover opacity-20"></div>
        <div className="relative z-10 w-full max-w-md p-8">
            
          <div className="text-center mb-8">
            <div className="inline-block p-4 bg-amber-600 rounded-full mb-4 shadow-lg shadow-amber-600/30">
              <Drama size={48} className="text-white" />
            </div>
            <h1 className="text-4xl font-serif font-bold text-white tracking-wider">RAJAWALIKU</h1>
            <p className="text-stone-400 mt-2">Aplikasi Ekstrakurikuler Teater</p>
          </div>

          <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl border border-white/10 shadow-xl">
            {notification && (
              <div className={`mb-4 p-3 rounded text-sm text-center ${notification.type === 'success' ? 'bg-green-500/20 text-green-200' : 'bg-red-500/20 text-red-200'}`}>
                {notification.msg}
              </div>
            )}
            
            {!isRegistering ? (
              <form onSubmit={handleLogin} className="space-y-4">
                <input 
                  type="text" 
                  placeholder="Username" 
                  className="w-full bg-stone-800/50 border border-stone-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none"
                  value={loginForm.username}
                  onChange={e => setLoginForm({...loginForm, username: e.target.value})}
                />
                <input 
                  type="password" 
                  placeholder="Password" 
                  className="w-full bg-stone-800/50 border border-stone-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none"
                  value={loginForm.password}
                  onChange={e => setLoginForm({...loginForm, password: e.target.value})}
                />
                <button disabled={loading} type="submit" className="w-full bg-amber-600 hover:bg-amber-500 disabled:bg-amber-800 text-white font-bold py-3 rounded-lg transition-colors">
                  {loading ? 'Memuat...' : 'Masuk Panggung'}
                </button>
                <p className="text-center text-stone-400 text-sm mt-4">
                  Belum punya akun? <button type="button" onClick={() => setIsRegistering(true)} className="text-amber-400 hover:underline">Daftar</button>
                </p>
              </form>
            ) : (
              <form onSubmit={handleRegister} className="space-y-4">
                <input type="text" placeholder="Nama Lengkap" className="w-full bg-stone-800/50 border border-stone-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none" value={regForm.name} onChange={e => setRegForm({...regForm, name: e.target.value})} />
                <input type="text" placeholder="Username Baru" className="w-full bg-stone-800/50 border border-stone-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none" value={regForm.username} onChange={e => setRegForm({...regForm, username: e.target.value})} />
                <input type="password" placeholder="Password Baru" className="w-full bg-stone-800/50 border border-stone-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none" value={regForm.password} onChange={e => setRegForm({...regForm, password: e.target.value})} />
                <button disabled={loading} type="submit" className="w-full bg-stone-700 hover:bg-stone-600 text-white font-bold py-3 rounded-lg transition-colors border border-stone-500">
                  {loading ? 'Mendaftar...' : 'Daftar Anggota'}
                </button>
                <p className="text-center text-stone-400 text-sm mt-4">
                  Sudah punya akun? <button type="button" onClick={() => setIsRegistering(false)} className="text-amber-400 hover:underline">Login</button>
                </p>
              </form>
            )}
          </div>
        </div>
      </div>
    );
  }

  const menuItems = [
    { id: 'dashboard', icon: LayoutDashboard, label: 'Dashboard' },
    { id: 'backstage', icon: Shirt, label: 'Backstage' },
    { id: 'activities', icon: Calendar, label: 'Kegiatan' },
    { id: 'forum', icon: MessageSquare, label: 'Forum' },
    { id: 'quiz', icon: Brain, label: 'Kuis' },
    ...(isAdmin ? [{ id: 'members', icon: Users, label: 'Anggota' }] : []), 
  ];

  return (
    <div className="flex h-screen bg-stone-100 text-stone-800 font-sans">
      {/* Sidebar Mobile Overlay */}
      {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={() => setIsSidebarOpen(false)}></div>}

      {/* Sidebar */}
      <aside className={`fixed md:static inset-y-0 left-0 z-30 w-64 bg-stone-900 text-stone-300 transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
        <div className="p-6 border-b border-stone-800 flex items-center gap-3">
          <div className="p-2 bg-amber-600 rounded-lg"><Drama size={24} className="text-white" /></div>
          <span className="font-serif font-bold text-xl text-white">RAJAWALIKU</span>
        </div>
        <nav className="p-4 space-y-2">
          {menuItems.map(item => (
            <button key={item.id} onClick={() => { setCurrentPage(item.id); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${currentPage === item.id ? 'bg-amber-600 text-white shadow-lg shadow-amber-900/20' : 'hover:bg-stone-800 hover:text-white'}`}>
              <item.icon size={20} />
              <span className="font-medium">{item.label}</span>
            </button>
          ))}
        </nav>
        <div className="absolute bottom-0 w-full p-4 border-t border-stone-800">
          <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-2 text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded-lg transition-colors">
            <LogOut size={20} /> <span>Keluar</span>
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col h-screen overflow-hidden">
        <header className="bg-white shadow-sm border-b border-stone-200 p-4 flex justify-between items-center z-10">
          <button onClick={() => setIsSidebarOpen(true)} className="md:hidden text-stone-600"><Menu /></button>
          <h2 className="text-xl font-bold text-stone-800 capitalize">{currentPage}</h2>
          <div className="flex items-center gap-3">
            <div className="text-right hidden sm:block">
              <p className="text-sm font-bold text-stone-800">{currentUser.name}</p>
              <p className="text-xs text-amber-600 uppercase font-semibold">{currentUser.role}</p>
            </div>
            <div className="w-10 h-10 bg-stone-200 rounded-full flex items-center justify-center text-stone-600 font-bold border-2 border-amber-100">
              {currentUser.name.charAt(0)}
            </div>
          </div>
        </header>

        <div className="flex-1 overflow-auto p-6 relative">
          {currentPage === 'dashboard' && <Dashboard />}
          {currentPage === 'activities' && <ActivitiesPage />}
          {currentPage === 'backstage' && <BackstagePage />}
          {currentPage === 'forum' && <ForumPage />}
          {currentPage === 'quiz' && <QuizPage />}
          {currentPage === 'members' && (
            <div className="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
              <h2 className="text-2xl font-bold mb-4">Data Anggota</h2>
              <table className="w-full text-left">
                <thead className="bg-stone-50 text-stone-500">
                  <tr><th className="p-3">Nama</th><th className="p-3">Role</th></tr>
                </thead>
                <tbody>
                  {users.map(u => (
                    <tr key={u.id} className="border-b border-stone-100">
                      <td className="p-3">{u.name}</td>
                      <td className="p-3"><span className={`px-2 py-1 rounded text-xs ${u.role==='admin'?'bg-amber-100 text-amber-800':'bg-stone-100'}`}>{u.role}</span></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </main>

      {/* Generic Modal */}
      {modalOpen && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-4 border-b flex justify-between items-center bg-stone-50">
              <h3 className="font-bold text-lg text-stone-800">{modalTitle}</h3>
              <button onClick={closeModal} className="text-stone-400 hover:text-stone-600"><X size={20}/></button>
            </div>
            <div className="p-6">
              {modalContent}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TeaterApp;
